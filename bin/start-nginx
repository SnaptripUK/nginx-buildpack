#!/usr/bin/env bash

psmgr=/tmp/nginx-buildpack-wait
rm -f $psmgr
mkfifo $psmgr

#Evaluate config to get $PORT and $NGINX_WORKERS
envsubst '${PORT} ${NGINX_WORKERS}' < conf/nginx.conf.template > conf/nginx.conf

#Initialize log directory.
mkdir -p logs/nginx
touch logs/nginx/access.log logs/nginx/error.log
echo 'buildpack=nginx-prerenderer at=logs-initialized'

#Start log redirection.
(
	#Redirect NGINX logs to stdout.
	tail -qF -n 0 logs/nginx/*.log
	echo 'logs' >$psmgr
) &

#Start NGINX
(
	#We expect nginx to run in foreground.
	#We also expect a socket to be at /tmp/nginx.socket.
	echo 'buildpack=nginx-prerenderer at=nginx-start'
	bin/nginx -p . -c conf/nginx.conf
	echo 'nginx' >$psmgr
) &

while ! nc -z localhost 19000; do   
	echo 'buildpack=nginx-prerenderer at=waiting-for-nginx'
	sleep 1
done
echo 'buildpack=nginx-prerenderer at=nginx-initialized'
  
#Start App Server
(		
	LINE=${@:$n}
	repl=""
        COMMAND="${LINE/bin'/'start-nginx/$repl}"
  	echo "buildpack=nginx-prerenderer at=start-app cmd=$COMMAND"
  	$COMMAND
)
